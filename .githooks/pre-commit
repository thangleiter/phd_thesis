#!/bin/sh
# pre-commit hook: Copy a file from one location to another

if [ "$(git rev-parse --abbrev-ref HEAD)" != "tectonic" ]; then
  # Skip this hook if we're not on main
  exit 0
fi

SRC_FILE="build/default/default.pdf"
DEST_FILE="review/main.pdf"

# Check if the source file exists
if [ ! -f "$SRC_FILE" ]; then
    echo "Error: Source file '$SRC_FILE' not found. Aborting commit."
    exit 1
fi

# Perform the copy operation
if ! cp "$SRC_FILE" "$DEST_FILE"; then
    echo "Error: Failed to copy '$SRC_FILE' to '$DEST_FILE'. Aborting commit."
    exit 1
else
  git add "$DEST_FILE"
fi

echo "Successfully copied '$SRC_FILE' to '$DEST_FILE'."

# Check if review/main.pdf is in a conflicted state.
if git ls-files -u "$DEST_FILE" > /dev/null 2>&1; then
    echo "Conflict detected in '$DEST_FILE'. Auto-restoring it to their version."
    git checkout --theirs "$DEST_FILE"
    git add "$DEST_FILE"
fi

exit 0
